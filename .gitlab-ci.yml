default:
  image: webdevops/php:7.4

cache: &cache
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .Build/
  policy: pull

variables:
  COMPOSER_ALLOW_SUPERUSER: "1"
  COMPOSER_NO_INTERACTION: "1"
  GIT_CLONE_PATH: $CI_BUILDS_DIR/$CI_JOB_ID/$CI_PROJECT_PATH

stages:
  - build
  - lint
  - sca
  - test
  - release

build:
  stage: build
  script:
    - composer install --no-progress
  cache:
    <<: *cache
    policy: pull-push
  rules:
    - if: '$CI_COMMIT_BRANCH'
      when: on_success

lint:php:
  stage: lint
  needs:
    - build
  script:
    - composer lint:php -- --dry-run
  rules:
    - if: '$CI_COMMIT_BRANCH'
      when: on_success

lint:typoscript:
  stage: lint
  needs:
    - build
  script:
    - composer lint:typoscript -- --fail-on-warnings
  rules:
    - if: '$CI_COMMIT_BRANCH'
      when: on_success

lint:composer:
  stage: lint
  needs:
    - build
  script:
    - composer normalize --dry-run
  rules:
    - if: '$CI_COMMIT_BRANCH'
      when: on_success

sca:php:
  stage: sca
  needs:
    - build
  script:
    - composer sca:php -- --error-format gitlab > .Build/phpstan.json
  artifacts:
    reports:
      codequality: .Build/phpstan.json
  rules:
    - if: '$CI_COMMIT_BRANCH'
      when: on_success

test:unit:
  image: webdevops/php:${PHP_VERSION}
  stage: test
  before_script:
    - >
      if [ "$COVERAGE" == "1" ]; then
        pecl channel-update pecl.php.net
        pecl install pcov
        docker-php-ext-enable pcov
      fi
    - php --version
  script:
    - mkdir -p .Build/coverage
    - >
      if [ "$TYPO3_VERSION" == "11.1" ]; then
        composer require --dev --no-progress "saschaegerer/phpstan-typo3:0.12.x-dev"
      fi
    - composer require --no-progress "typo3/cms-core:~${TYPO3_VERSION}.0"
    - >
      if [ "$COVERAGE" == "1" ]; then
        composer test:coverage
      else
        composer test
      fi
  parallel:
    matrix:
      - PHP_VERSION: ["7.2", "7.3", "7.4"]
        TYPO3_VERSION: "10.4"
      - PHP_VERSION: "7.4"
        TYPO3_VERSION: "10.4"
        COVERAGE: "1"
      - PHP_VERSION: "7.4"
        TYPO3_VERSION: "11.1"
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  cache:
    <<: *cache
    key: "${CI_COMMIT_REF_SLUG}-${PHP_VERSION}-${TYPO3_VERSION}"
    policy: pull-push
  artifacts:
    reports:
      junit: .Build/coverage/junit.xml
  rules:
    - if: '$CI_COMMIT_BRANCH'
      when: on_success

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release for ${CI_COMMIT_TAG}"
  release:
    name: '${CI_COMMIT_TAG}'
    description: '${CI_COMMIT_TAG}'
    tag_name: '${CI_COMMIT_TAG}'
    ref: '${CI_COMMIT_TAG}'
  rules:
    - if: '$CI_COMMIT_TAG'
      when: on_success
