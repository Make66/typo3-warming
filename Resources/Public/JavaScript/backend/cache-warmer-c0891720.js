import e from"@typo3/backend/action-button/immediate-action.js";import t from"@typo3/backend/notification.js";import r from"@typo3/core/ajax/ajax-request.js";import s from"@typo3/backend/modal.js";import a from"jquery";import o from"@typo3/backend/icons.js";let n;const i=new Uint8Array(16);function l(){if(!n&&(n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!n))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(i)}const d=[];for(let e=0;e<256;++e)d.push((e+256).toString(16).slice(1));var c,u,g,p,m={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function h(e,t,r){if(m.randomUUID&&!t&&!e)return m.randomUUID();const s=(e=e||{}).random||(e.rng||l)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=s[e];return t}return function(e,t=0){return(d[e[t+0]]+d[e[t+1]]+d[e[t+2]]+d[e[t+3]]+"-"+d[e[t+4]]+d[e[t+5]]+"-"+d[e[t+6]]+d[e[t+7]]+"-"+d[e[t+8]]+d[e[t+9]]+"-"+d[e[t+10]]+d[e[t+11]]+d[e[t+12]]+d[e[t+13]]+d[e[t+14]]+d[e[t+15]]).toLowerCase()}(s)}!function(e){e.approved="overlay-approved",e.check="actions-check",e.exclamationCircle="actions-exclamation-circle-alt",e.listAlternative="actions-list-alternative",e.readonly="overlay-readonly",e.refresh="actions-refresh",e.rocket="actions-rocket",e.spinner="spinner-circle-light",e.viewPage="actions-view-page",e.warning="overlay-warning"}(c||(c={})),function(e){e.notificationShowReport="warming.notification.action.showReport",e.notificationActionRetry="warming.notification.action.retry",e.notificationAbortedTitle="warming.notification.aborted.title",e.notificationAbortedMessage="warming.notification.aborted.message",e.notificationErrorTitle="warming.notification.error.title",e.notificationErrorMessage="warming.notification.error.message",e.notificationNoSitesSelectedTitle="warming.notification.noSitesSelected.title",e.notificationNoSitesSelectedMessage="warming.notification.noSitesSelected.message",e.modalProgressTitle="warming.modal.progress.title",e.modalProgressButtonReport="warming.modal.progress.button.report",e.modalProgressButtonRetry="warming.modal.progress.button.retry",e.modalProgressButtonClose="warming.modal.progress.button.close",e.modalProgressFailedCounter="warming.modal.progress.failedCounter",e.modalProgressAllCounter="warming.modal.progress.allCounter",e.modalProgressPlaceholder="warming.modal.progress.placeholder",e.modalReportTitle="warming.modal.report.title",e.modalReportPanelFailed="warming.modal.report.panel.failed",e.modalReportPanelFailedSummary="warming.modal.report.panel.failed.summary",e.modalReportPanelSuccessful="warming.modal.report.panel.successful",e.modalReportPanelSuccessfulSummary="warming.modal.report.panel.successful.summary",e.modalReportPanelExcluded="warming.modal.report.panel.excluded",e.modalReportPanelExcludedSummary="warming.modal.report.panel.excluded.summary",e.modalReportPanelExcludedSitemaps="warming.modal.report.panel.excluded.sitemaps",e.modalReportPanelExcludedUrls="warming.modal.report.panel.excluded.urls",e.modalReportActionView="warming.modal.report.action.view",e.modalReportTotal="warming.modal.report.message.total",e.modalReportNoUrlsCrawled="warming.modal.report.message.noUrlsCrawled",e.modalSitesTitle="warming.modal.sites.title",e.modalSitesUserAgentActionSuccessful="warming.modal.sites.userAgent.action.successful",e.modalSitesButtonStart="warming.modal.sites.button.start"}(u||(u={}));class f{constructor(e){this.progress=e,this.panelCount=0}static createModalAction(t,r){return{label:TYPO3.lang[u.notificationShowReport],action:new e((()=>{f.createModal(t,r)}))}}static createModal(e,t){const r=new f(e);return Promise.all([o.getIcon(c.readonly,o.sizes.medium),o.getIcon(c.approved,o.sizes.medium),o.getIcon(c.warning,o.sizes.medium),o.getIcon(c.viewPage,o.sizes.small)]).then((([a,o,n,i])=>{s.dismiss();const l=r.buildModalContent(a,o,n,i),d=e.progress.current>0?`${TYPO3.lang[u.modalReportTotal]} ${e.progress.current}`:TYPO3.lang[u.modalReportNoUrlsCrawled];s.advanced({title:TYPO3.lang[u.modalReportTitle],content:l,size:s.sizes.large,buttons:[{text:d,icon:c.exclamationCircle,btnClass:"disabled border-0"},{text:TYPO3.lang[u.modalProgressButtonRetry],icon:c.refresh,btnClass:"btn-default",trigger:t},{text:TYPO3.lang[u.modalProgressButtonClose],btnClass:"btn-default",trigger:()=>s.dismiss()}]})})),r}createPanel(e,t,r,s){const o="tx-warming-panel-"+this.panelCount++;return a("<div>").addClass(`panel panel-${t}`).append(a("<div>").addClass("panel-heading").append(a("<h3>").addClass("panel-title").append(a("<a>").addClass("collapsed").attr("href",`#${o}`).attr("data-bs-toggle","collapse").attr("aria-controls",o).attr("aria-expanded","false").append(a("<span>").addClass("caret"),a("<strong>").text(` ${e} (${r.length})`)))),a("<div>").attr("id",o).addClass("panel-collapse collapse").append(a("<div>").addClass("table-fit").append(a("<table>").addClass("table table-striped table-hover").append(a("<tbody>").append(r.map((e=>a("<tr>").append(a("<td>").text(e),a("<td>").addClass("col-control nowrap").append(a("<div>").addClass("btn-group").append(a("<a>").attr("href",e).attr("target","_blank").addClass("btn btn-default btn-sm nowrap").html(`${s} ${TYPO3.lang[u.modalReportActionView]}`)))))))))))}createSummaryCard(e,t,r,s,o,n=null){return a("<div>").addClass("col-4").append(a("<div>").addClass(`card card-${r} h-100`).append(a("<div>").addClass("card-header").append(a("<div>").addClass("card-icon").html(s),a("<div>").addClass("card-header-body").append(a("<h1>").addClass("card-title").text(e),a("<span>").addClass("card-subtitle").html(null!==n?`<strong>${o}</strong>/${n}`:o.toString()))),a("<div>").addClass("card-body").append(a("<p>").addClass("card-text").text(t))))}buildModalContent(e,t,r,s){this.panelCount=0;const o=this.progress.getNumberOfExcludedSitemaps()+this.progress.getNumberOfExcludedUrls(),n=a("<div>").addClass("card-container"),i=a("<div>").append(n);return this.progress.getNumberOfFailedUrls()>0&&n.append(this.createSummaryCard(TYPO3.lang[u.modalReportPanelFailed],TYPO3.lang[u.modalReportPanelFailedSummary],"danger",e,this.progress.getNumberOfFailedUrls(),this.progress.progress.current)),this.progress.getNumberOfSuccessfulUrls()>0&&n.append(this.createSummaryCard(TYPO3.lang[u.modalReportPanelSuccessful],TYPO3.lang[u.modalReportPanelSuccessfulSummary],"success",t,this.progress.getNumberOfSuccessfulUrls(),this.progress.progress.current)),o>0&&n.append(this.createSummaryCard(TYPO3.lang[u.modalReportPanelExcluded],TYPO3.lang[u.modalReportPanelExcludedSummary],"warning",r,o)),this.progress.getNumberOfFailedUrls()>0&&i.append(this.createPanel(TYPO3.lang[u.modalReportPanelFailed],"danger",this.progress.urls.failed,s)),this.progress.getNumberOfSuccessfulUrls()>0&&i.append(this.createPanel(TYPO3.lang[u.modalReportPanelSuccessful],"success",this.progress.urls.successful,s)),this.progress.getNumberOfExcludedSitemaps()>0&&i.append(this.createPanel(TYPO3.lang[u.modalReportPanelExcludedSitemaps],"warning",this.progress.excluded.sitemaps,s)),this.progress.getNumberOfExcludedUrls()>0&&i.append(this.createPanel(TYPO3.lang[u.modalReportPanelExcludedUrls],"warning",this.progress.excluded.urls,s)),i}}class b{static formatString(e,...t){return t.reduce(((e,t,r)=>e.replace(new RegExp(`\\{${r}}`),t)),e)}}!function(e){e.Failed="failed",e.Warning="warning",e.Success="success",e.Aborted="aborted",e.Unknown="unknown"}(g||(g={})),function(e){e.reportButton="tx-warming-open-report",e.retryButton="tx-warming-retry"}(p||(p={}));class w{static createModal(){const e=new this,t=e.buildInitialModalContent();return s.dismiss(),e.$modal=e.createModalWithContent(t),e.$modal.find(".modal-footer").hide(),e}updateProgress(e){const t=e.getCurrentUrl(),r=e.getProgressInPercent(),s=e.getNumberOfFailedUrls(),{current:a,total:o}=e.progress;this.$progressBar.addClass("progress-bar-animated active"),this.$progressBar.attr("aria-valuenow",a),this.$progressBar.attr("aria-valuemax",o),this.$progressBar.css("width",`${r}%`),this.$progressBar.html(`${r.toFixed(2)}%`),s>0&&(this.$progressBar.addClass("progress-bar-warning bg-warning"),this.$failedCounter.show().html(b.formatString(TYPO3.lang[u.modalProgressFailedCounter],s.toString()))),this.$allCounter.html(b.formatString(TYPO3.lang[u.modalProgressAllCounter],a.toString(),o.toString())),""!==t&&this.$currentUrl.html(t),e.isFinished()&&(this.$progressBar.removeClass("progress-bar-animated active").removeClass("progress-bar-warning bg-warning").addClass(s>0?"progress-bar-danger bg-danger":"progress-bar-success bg-success"),this.$currentUrl.remove())}finishProgress(e,t){this.getReportButton().removeClass("hidden").off("click").on("click",(()=>{f.createModal(e,t)})),e.state!==g.Aborted&&this.getRetryButton().removeClass("hidden").off("click").on("click",t)}getModal(){return this.$modal}getReportButton(){return this.$modal.find(`button[name=${p.reportButton}]`)}getRetryButton(){return this.$modal.find(`button[name=${p.retryButton}]`)}buildInitialModalContent(){const e=a('<div class="tx-warming-progress-modal">');return this.$progressBar=a('<div class="progress-bar progress-bar-striped progress-bar-animated active">').attr("role","progressbar").attr("aria-valuemin",0).attr("aria-valuemax",0).attr("aria-valuenow",0),this.$allCounter=a("<div>").html(TYPO3.lang[u.modalProgressPlaceholder]),this.$failedCounter=a('<div class="badge badge-danger">'),this.$currentUrl=a('<div class="tx-warming-progress-modal-current-url">'),this.$failedCounter.hide(),e.append(a('<div class="tx-warming-progress-modal-progress progress">').append(this.$progressBar)).append(a('<div class="tx-warming-progress-modal-counter">').append(this.$allCounter,this.$failedCounter)).append(this.$currentUrl),e}createModalWithContent(e){return a(s.advanced({title:TYPO3.lang[u.modalProgressTitle],content:e,size:s.sizes.small,staticBackdrop:!0,buttons:[{text:TYPO3.lang[u.modalProgressButtonReport],icon:c.listAlternative,btnClass:"btn-primary hidden",name:p.reportButton},{text:TYPO3.lang[u.modalProgressButtonRetry],icon:c.refresh,btnClass:"btn-default hidden",name:p.retryButton},{text:TYPO3.lang[u.modalProgressButtonClose],btnClass:"btn-default",trigger:()=>s.dismiss()}]}))}}class P{static mergeUrlWithQueryParams(e,t){for(const[r,s]of t.entries())e.searchParams.append(r,s);return e}}class C{constructor(e){this.state=g.Unknown,this.progress={current:0,total:0},this.urls={current:"",failed:[],successful:[]},this.excluded={sitemaps:[],urls:[]},this.response={title:"",message:""},e&&this.update(e)}update(e){return e.state&&Object.values(g).includes(e.state)&&(this.state=e.state),e.progress&&(this.progress=e.progress),e.urls&&(this.urls=e.urls),e.excluded&&(this.excluded=e.excluded),e.title&&(this.response.title=e.title),e.messages&&(this.response.message=e.messages.join("\n\n")),this}getCurrentUrl(){return this.urls.current}getNumberOfFailedUrls(){return this.urls.failed.length}getNumberOfSuccessfulUrls(){return this.urls.successful.length}getProgressInPercent(){return 0!==this.progress.total?Number(this.progress.current/this.progress.total*100):Number(0)}getNumberOfExcludedSitemaps(){return this.excluded.sitemaps.length}getNumberOfExcludedUrls(){return this.excluded.urls.length}isFinished(){return this.progress.current>=this.progress.total}}class S{startRequestWithQueryParams(e,t){return this.progressModal=w.createModal(),this.request=new r(this.getUrl(e).toString()),this.progress=new C,this.progressModal.getModal().on("hide.bs.modal",(()=>{this.abortWarmup()})),this.request.post({}).then((async e=>{const r=await e.resolve();return this.finishWarmup(r,t),this.progress})).catch((async e=>(this.reject(),await e.resolve(),this.progress)))}getUrl(e){const t=new URL(TYPO3.settings.ajaxUrls.tx_warming_cache_warmup_legacy,window.location.origin);return P.mergeUrlWithQueryParams(t,e)}cancelRequest(){this.request.abort()}finishWarmup(e,t){this.progress.update(e),this.progressModal.updateProgress(this.progress),this.cancelRequest(),this.progressModal.finishProgress(this.progress,t)}abortWarmup(){this.cancelRequest(),this.progress.update({state:g.Aborted})}reject(){this.cancelRequest(),s.dismiss()}}class y{startRequestWithQueryParams(e,t){return this.progressModal=w.createModal(),this.source=new EventSource(this.getUrl(e).toString(),{withCredentials:!0}),this.progress=new C,new Promise(((e,r)=>{this.progressModal.getModal().on("hide.bs.modal",(()=>{this.abortWarmup(),e(this.progress)})),this.source.addEventListener("warmupProgress",(e=>this.updateProgress(e)),!1),this.source.addEventListener("warmupFinished",(r=>{this.finishWarmup(r,t),e(this.progress)}),!1),this.source.addEventListener("message",(()=>this.reject(r)),!1),this.source.addEventListener("error",(()=>this.reject(r)),!1)}))}getUrl(e){const t=new URL(TYPO3.settings.ajaxUrls.tx_warming_cache_warmup,window.location.origin);return P.mergeUrlWithQueryParams(t,e)}static isSupported(){return!!window.EventSource}closeSource(){return this.source.close(),EventSource.CLOSED===this.source.readyState}updateProgress(e){const t=JSON.parse(e.data);this.progress.update(t),this.progressModal.updateProgress(this.progress)}finishWarmup(e,t){const r=JSON.parse(e.data);this.progress.update(r),this.closeSource(),this.progressModal.finishProgress(this.progress,t)}abortWarmup(){this.closeSource(),this.progress.update({state:g.Aborted})}reject(e){this.closeSource(),s.dismiss(),e()}}class v{constructor(){this.handler=this.initializeRequestHandler()}warmupCache(t,r,s={}){const a=this.buildQueryParams(t,r,s),o=()=>this.warmupCache(t,r,s);return this.handler.startRequestWithQueryParams(a,o).then((t=>{let r;return t.state===g.Aborted&&(r={label:TYPO3.lang[u.notificationActionRetry],action:new e(o)}),v.showNotification(t,o,r),t}),(e=>(v.errorNotification(),e)))}initializeRequestHandler(){return y.isSupported()?new y:new S}buildQueryParams(e,t,r={}){const s=new URLSearchParams({requestId:v.generateRequestId()});let a=0,o=0;for(const[t,r]of Object.entries(e)){const e=a++;s.set(`sites[${e}][site]`,t),r.forEach((t=>s.set(`sites[${e}][languageIds][]`,(t??0).toString())))}for(const[e,r]of Object.entries(t)){const t=o++;s.set(`pages[${t}][page]`,e.toString()),r.forEach((e=>s.set(`pages[${t}][languageIds][]`,(e??0).toString())))}for(const[e,t]of Object.entries(r))s.set(`configuration[${e}]`,t.toString());return s}static generateRequestId(){return h()}static showNotification(e,r,s){let{title:a,message:o}=e.response;const n=[f.createModalAction(e,r)];switch(s&&n.push(s),e.state){case g.Failed:t.error(a,o,0,n);break;case g.Warning:t.warning(a,o,0,n);break;case g.Success:t.success(a,o,15,n);break;case g.Aborted:a=TYPO3.lang[u.notificationAbortedTitle],o=TYPO3.lang[u.notificationAbortedMessage],t.info(a,o,15,n);break;case g.Unknown:t.notice(a,o,15);break;default:v.errorNotification()}}static errorNotification(){t.error(TYPO3.lang[u.notificationErrorTitle],TYPO3.lang[u.notificationErrorMessage])}}export{v as C,c as I,u as L};
