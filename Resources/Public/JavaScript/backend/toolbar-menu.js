import e from"@typo3/core/document-service.js";import t from"@typo3/core/event/regular-event.js";import n from"jquery";import r from"@typo3/backend/icons.js";import o from"@typo3/backend/modal.js";import i from"@typo3/backend/notification.js";import{C as a,L as s,I as l}from"./cache-warmer-fd484775.js";import"@typo3/backend/action-button/immediate-action.js";import"@typo3/core/ajax/ajax-request.js";var c="text/plain",u=e=>{};function d(e){u(e)}var p=!0;(function(){(console.warn||console.log).apply(console,arguments)}).bind("[clipboard-polyfill]");var g,h,m,f="undefined"==typeof window?void 0:window,v="undefined"==typeof globalThis?void 0:globalThis,b=null!=(m=null==(g=f)?void 0:g.Promise)?m:null==(h=v)?void 0:h.Promise;var y,w,x,C,k,T="undefined"==typeof navigator?void 0:navigator,S=null==T?void 0:T.clipboard,A=null==(y=null==S?void 0:S.read)?void 0:y.bind(S),E=null==(w=null==S?void 0:S.readText)?void 0:w.bind(S),I=null==(x=null==S?void 0:S.write)?void 0:x.bind(S),j=null==(C=null==S?void 0:S.writeText)?void 0:C.bind(S),G=null==(k=f)?void 0:k.ClipboardItem,D=function(){if(!b)throw new Error("No `Promise` implementation available for `clipboard-polyfill`. Consider using: https://github.com/lgarron/clipboard-polyfill#flat-file-version-with-promise-included");return b}(),O=f;function U(){return"undefined"==typeof ClipboardEvent&&void 0!==(null==O?void 0:O.clipboardData)&&void 0!==(null==O?void 0:O.clipboardData.setData)}function W(e,t,n){for(var r in d("listener called"),e.success=!0,t){var o=t[r],i=n.clipboardData;i.setData(r,o),r===c&&i.getData(r)!==o&&(d("setting text/plain failed"),e.success=!1)}n.preventDefault()}function B(e){var t={success:!1},n=W.bind(this,t,e);document.addEventListener("copy",n);try{document.execCommand("copy")}finally{document.removeEventListener("copy",n)}return t.success}function P(e,t){R(e);var n=B(t);return N(),n}function R(e){var t=document.getSelection();if(t){var n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}}function N(){var e=document.getSelection();e&&e.removeAllRanges()}function L(e){var t,n,r=c in e;if(U()){if(!r)throw new Error("No `text/plain` value was specified.");if(t=e[c],(n=O.clipboardData.setData("Text",t))&&d("writeTextIE worked"),n)return!0;throw new Error("Copying failed, possibly because the user rejected it.")}return B(e),navigator.userAgent.indexOf("Edge")>-1?(d('UA "Edge" => assuming success'),!0):P(document.body,e)?(d("copyUsingTempSelection worked"),!0):function(e){var t=document.createElement("div");t.setAttribute("style","-webkit-user-select: text !important"),t.textContent="temporary element",document.body.appendChild(t);var n=P(t,e);return document.body.removeChild(t),n}(e)?(d("copyUsingTempElem worked"),!0):!!function(e){d("copyTextUsingDOM");var t=document.createElement("div");t.setAttribute("style","-webkit-user-select: text !important");var n=t;t.attachShadow&&(d("Using shadow DOM."),n=t.attachShadow({mode:"open"}));var r=document.createElement("span");r.innerText=e,n.appendChild(r),document.body.appendChild(t),R(r);var o=document.execCommand("copy");return N(),document.body.removeChild(t),o}(e[c])&&(d("copyTextUsingDOM worked"),!0)}function z(e,t){var n=[];for(var r in e){var o=e[r];n.push(t(o))}return D.all(n).then((t=>{for(var n={},r=0;r<e.length;r++)n[e[r]]=t[r];return n}))}var _=D.resolve(),M=()=>D.resolve(!0),Y=D.resolve(!1);function J(e){return new D(((t,n)=>{try{t(e())}catch(e){n(e)}}))}function F(e){if(!L(function(e){var t={};return t[c]=e,t}(e)))throw new Error("writeText() failed")}function $(){return J((()=>{if(E)return d("Using `navigator.clipboard.readText()`."),E();if(U()){var e=function(){var e=O.clipboardData.getData("Text");if(""===e)throw new Error("Empty clipboard or could not read plain text from clipboard");return e}();return D.resolve(e)}throw new Error("Read is not supported in your browser.")}))}function q(e,t){for(var n in e){if(-1!==e[n].types.indexOf(t))return!0}return!1}var V=function(e,t){var n,r=Object.keys(e),o={};for(var i in e){var a=e[i];o[i]="string"==typeof a?H(i,a):a}return{types:r,presentationStyle:null!=(n=null==t?void 0:t.presentationStyle)?n:"unspecified",getType:function(e){return D.resolve(o[e])}}};function H(e,t){return new Blob([t],{type:e})}function K(e){return z(e.types,(function(t){return e.getType(t)})).then((t=>{var n={};return e.presentationStyle&&(n.presentationStyle=e.presentationStyle),new G(t,n)}))}function Q(e){var t={};return t[c]=H(e,c),new V(t)}function X(e,t){return e.getType(t).then((e=>{return t=e,new D(((e,n)=>{var r=new FileReader;r.addEventListener("load",(()=>{var t=r.result;"string"==typeof t?e(t):n("could not convert blob to string")})),r.readAsText(t)}));var t}))}var Z,ee,te,ne=Object.freeze({__proto__:null,ClipboardItem:V,read:function(){return J((()=>A?(d("Using `navigator.clipboard.read()`."),A()):$().then((e=>[Q(e)]))))},readText:$,setDebugLog:function(e){u=e},suppressWarnings:function(){p=!1},write:function(e){return J((()=>{if(I&&G){var t=I;return d("Using `navigator.clipboard.write()`."),D.all(e.map(K)).then((n=>t(n).then(M).catch((t=>{if(!q(e,c)&&!q(e,"text/html"))throw t;return Y}))))}return Y})).then((t=>{if(t)return _;var n=q(e,c);return p&&!n&&d("clipboard.write() was called without a `text/plain` data type. On some platforms, this may result in an empty clipboard. Call suppressWarnings() to suppress this warning."),function(e){return z(e.types,(function(t){return X(e,t)}))}(e[0]).then((e=>{if(!L(e))throw new Error("write() failed")}))}))},writeText:function(e){return J((()=>j?(d("Using `navigator.clipboard.writeText()`."),j(e).catch(F)):D.resolve(F(e))))}});class re extends Error{static create(){return new re("The given site selection object is invalid.")}}class oe{constructor(e,t,n){this.site=e,this.language=t,this.group=n}static fromJson(e){const t=JSON.parse(e);if("object"!=typeof t)throw re.create();if(!("site"in t))throw re.create();return new oe(t.site,t.language??null,t.group??null)}getSiteIdentifier(){return this.site}getLanguageId(){return this.language}getGroupName(){return this.group}isWithinGroup(){return null!==this.group}isGroupRoot(){return this.isWithinGroup()&&null===this.language}isGroupItem(){return this.isWithinGroup()&&null!==this.language}}!function(e){e.form=".tx-warming-sites-modal",e.siteCheckbox=".tx-warming-sites-group-selector > input",e.siteCheckboxAll=".tx-warming-sites-group-selector > input[data-select-all]",e.useragentCopy="button.tx-warming-user-agent-copy-action",e.useragentCopyIcon=".t3js-icon",e.useragentCopyText=".tx-warming-user-agent-copy-text"}(Z||(Z={})),function(e){e.startButton="tx-warming-start-warmup"}(ee||(ee={}));class ie{constructor(){this.cacheWarmer=new a,this.createModal()}createModal(){const e=new URL(TYPO3.settings.ajaxUrls.tx_warming_fetch_sites,window.location.origin);o.dismiss(),this.modal=o.advanced({type:o.types.ajax,content:e.toString(),title:TYPO3.lang[s.modalSitesTitle],size:o.sizes.medium,buttons:[{text:TYPO3.lang[s.modalSitesButtonStart],icon:l.rocket,btnClass:"btn-primary disabled",name:ee.startButton,trigger:()=>{n(this.modal).find(Z.form).submit()}}],ajaxCallback:e=>this.initializeSites(e)})}initializeSites(e){n(this.modal).find(".modal-footer").addClass("tx-warming-modal-footer").addClass("visually-hidden"),n(e).off("submit",Z.form),n(e).on("submit",Z.form,(e=>(e.preventDefault(),this.performCacheWarmup(e.target),!1))),n(e).on("input",Z.siteCheckbox,(e=>{n(this.modal).find(".modal-footer").removeClass("visually-hidden"),this.toggleInputs(e.target)})),n(e).on("click",Z.useragentCopy,(e=>{e.preventDefault(),e.stopImmediatePropagation();const t=n(e.currentTarget).attr("data-text");t&&ie.copyUserAgentToClipboard(t)}))}performCacheWarmup(e){if(!this.areSitesSelected())return void i.warning(TYPO3.lang[s.notificationNoSitesSelectedTitle],TYPO3.lang[s.notificationNoSitesSelectedMessage],15);const{configuration:t,sites:n}=this.parseFormValues(e);this.cacheWarmer.warmupCache(n,[],t)}parseFormValues(e){const t=n(e).serializeArray(),r={},o={};return t.forEach((({name:e,value:t})=>{switch(e){case"site":try{const e=oe.fromJson(t),n=e.getSiteIdentifier();e.isGroupRoot()||(n in o||(o[n]=[]),o[n].push(e.getLanguageId()))}catch(e){}break;case"limit":r.limit=parseInt(t);break;case"strategy":r.strategy=t}})),{configuration:r,sites:o}}toggleInputs(e){if(e.dataset.selectAll)this.toggleAll(e.checked);else{const t=oe.fromJson(e.value);t.isWithinGroup()&&this.toggleGroup(t,e),this.toggleSelectAll(e)}this.areSitesSelected()?this.getStartButton().removeClass("disabled"):this.getStartButton().addClass("disabled")}areSitesSelected(){let e=!1;return this.getCheckboxes(!0).each((function(){if(this.checked)return e=!0,!1})),e}toggleGroup(e,t){let n=t.checked;null===e.getLanguageId()?this.getCheckboxesByGroup(e.getGroupName()).each((function(){this.checked=n})):(n&&this.getCheckboxesByGroup(e.getGroupName()).each((function(){if(this.id!==t.id&&!this.checked)return n=!1,!1})),this.getCheckboxGroupRoot(e.getGroupName()).checked=n)}toggleAll(e){this.getCheckboxes().each((function(){this.checked=e}))}toggleSelectAll(e){let t=e.checked;t&&this.getCheckboxes(!0).each((function(){if(this.id!==e.id&&!this.checked)return t=!1,!1})),this.getSelectAllCheckbox().checked=t}getCheckboxes(e=!1){let t=Z.siteCheckbox+":enabled";return e&&(t+=":not([data-select-all])"),n(this.modal).find(t)}getSelectAllCheckbox(){return n(this.modal).find(Z.siteCheckboxAll).get(0)}getCheckboxesByGroup(e){return n(this.modal).find(`input[data-group="${e}"]:enabled`)}getCheckboxGroupRoot(e){return n(this.modal).find(`input[data-group-root="${e}"]:enabled`).get(0)}getStartButton(){return n(this.modal).find(`button[name=${ee.startButton}]`)}static copyUserAgentToClipboard(e){const t=n(Z.useragentCopyIcon,Z.useragentCopy),o=t.clone();r.getIcon(l.spinner,r.sizes.small).then((e=>{t.replaceWith(e)})),Promise.all([(navigator.clipboard??ne).writeText(e),r.getIcon(l.check,r.sizes.small)]).then((async([,e])=>{const t=n(Z.useragentCopyText).text();n(Z.useragentCopyText).text(TYPO3.lang[s.modalSitesUserAgentActionSuccessful]),n(Z.useragentCopyIcon,Z.useragentCopy).replaceWith(e),window.setTimeout((()=>{n(Z.useragentCopyIcon,Z.useragentCopy).replaceWith(o),n(Z.useragentCopyText).text(t),n(Z.useragentCopy).trigger("blur")}),3e3)}),(()=>{n(Z.useragentCopyIcon,Z.useragentCopy).replaceWith(o)}))}}!function(e){e.container="#eliashaeussler-typo3warming-backend-toolbaritems-cachewarmuptoolbaritem"}(te||(te={}));var ae=new class{constructor(){e.ready().then((()=>{new t("click",(()=>{new ie})).delegateTo(document,te.container)}))}};export{ae as default};
